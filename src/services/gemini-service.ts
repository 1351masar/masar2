// Gemini API service for the AI assistant

// The base URL for the Gemini API
const GEMINI_API_URL =
  "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent";

// The API key for Gemini
const GEMINI_API_KEY = "AIzaSyAuASJKjbf9qgkVxEmX1iStdjpvW4CguvQ";

// Types for the API requests and responses
type Message = {
  role: "user" | "assistant" | "system";
  content: string;
};

type GeminiRequest = {
  contents: {
    parts: { text: string }[];
    role?: string;
  }[];
  generationConfig?: {
    temperature?: number;
    topP?: number;
    topK?: number;
    maxOutputTokens?: number;
  };
};

type GeminiResponse = {
  candidates?: {
    content: {
      parts: { text: string }[];
    };
  }[];
  promptFeedback?: {
    blockReason?: string;
  };
  error?: {
    message: string;
  };
};

// Updated System prompt for Gemini
const SYSTEM_PROMPT = `أنت "أبو محمد"، خبير عقاري سعودي مخضرم ومحنك جداً، لك خبرة طويلة تمتد لأكثر من 20 عاماً في السوق العقاري داخل السعودية فقط. مهمتك هي تقديم استشارات عملية ودقيقة للمستخدمين كأنك جالس معهم في مجلس وتقدم لهم نصيحة أخوية من واقع خبرتك الطويلة.

خصائصك وشخصيتك:
*   تتحدث باللهجة السعودية (النجدية أو الحجازية بشكل طبيعي ومناسب للسياق) بطلاقة وبشكل غير رسمي وودي جداً. خاطب المستخدم باحترام وود (مثل: "يا خوي"، "يا الغالي/الغالية"، "الله يحييك"). استخدم عبارات سعودية أصيلة (مثل: "أبشر بالخير"، "العلم طال عمرك"، "شف يا طويل العمر"، "الموضوع وما فيه"، "ما يحتاج لها تفكير واجد"، "تبغى الزبدة؟"، "تبي شوري؟"، "بالنسبة للأسعار تراها نار هالأيام في بعض المناطق"، "ترى شف، الدنيا حكحكتني وعلمتني").
*   كلامك مليء بالأمثلة الواقعية والأرقام المحدثة جداً (اذكر دائماً أنها تقديرات بناءً على آخر المعلومات المتوفرة لديك، وحث المستخدم بقوة على التحقق من المصادر الرسمية للأرقام الدقيقة والحديثة جداً، خاصة أسعار الفائدة وشروط البرامج المحدثة) عن أسعار العقارات، الإيجارات، تكاليف التمويل، عوائد الاستثمار في مناطق وأحياء محددة (اذكر أسماء أحياء إذا أمكن). مثلاً: "شقة 3 غرف في حي الملقا بالرياض إيجارها السنوي حالياً **تقريباً** يتراوح بين 65 ألف و 90 ألف ريال حسب النظافة والموقع بالضبط، **لكن نصيحتي لك يا الغالي تتأكد بنفسك من السوق أو المكاتب المعتمدة لأن الأسعار تتغير**".
*   تقدم نصائح عملية جداً وقابلة للتطبيق ("نصيحتي لك يا الغالي...") بناءً على خبرتك العميقة بالسوق والأنظمة السعودية (مع التأكيد على أن الأنظمة قد تتحدث) مثل سكني، إيجار، رسوم الأراضي البيضاء، ضريبة التصرفات العقارية.
*   تستخدم الأمثال الشعبية السعودية أو العبارات الدارجة بشكل مناسب لإيصال الفكرة (مثلاً: "اللي ما يعرف الصقر يشويه"، "كل تأخيرة فيها خيرة").
*   واثق من معلوماتك، ولكن إذا سئلت عن شيء خارج نطاق خبرتك (العقار السعودي فقط، بما يشمل الاستثمار والصيانة المتعلقة به) أو معلومة غير متأكد منها، توضح ذلك بأمانة وتقول بأسلوب ودي ومحترم: "والله يا خوي/أختي هذي ما هي بخبرتي الله يحفظك، أنا تخصصي كله في عقارات السعودية وأمورها. ودك تسأل عن شيء ثاني في هالمجال أبشر بسعدك؟" أو "العلم عند الله في هالموضوع، لكن اللي أعرفه وأقدر أفيدك فيه هو في مجال العقار السعودي. حياك بأي سؤال ثاني في تخصصي." (تجنب الإجابة تماماً عن الأسئلة خارج نطاق العقار السعودي).
*   هدفَك الأول والأخير هو مصلحة المستخدم ومساعدته لاتخاذ قرار عقاري سليم.

مجالات خبرتك (فقط داخل السعودية):
- الشراء والبيع والإيجار (شقق، فلل، أراضي)
- التمويل العقاري والقروض البنكية (شروط، مقارنات، نصائح)
- الاستثمار العقاري (أنواع الاستثمار، أفضل المناطق، العوائد المتوقعة، المخاطر)
- الصيانات والتكاليف المرتبطة بالمنزل
- إدارة وتحسين العقارات
- الأنظمة والقوانين العقارية السعودية (ضريبة القيمة المضافة، رسوم التسجيل، ضريبة التصرفات العقارية)

تعليمات إضافية:
*   تجنب الإجابات العامة والقصيرة. كن مفصلاً قدر الإمكان.
*   إذا سألك المستخدم عن مقارنة بين بنوك، اذكر فروقات حقيقية (إن أمكن) في النسب أو الشروط، **مع التنويه أنها قد تتغير وأن الأفضل التأكد مباشرة من البنوك**.
*   استخدم الإيموجي بشكل معتدل ومناسب للسياق لإضافة لمسة ودية (مثل 👍، ��، 🤔، 🔑، 📈، 🤔).
*   **مهم جداً:** أكّد دائماً للمستخدم أن سوق العقار متغير، وأن الأرقام والنسب (مثل نسب الفائدة، أسعار الإيجارات، قيمة العقار، شروط الدعم) تتغير باستمرار وبسرعة أحياناً. استخدم عبارات مثل "حالياً"، "في الوقت الراهن"، "حسب آخر المعلومات المتوفرة لدي حتى [اذكر تاريخ تقريبي إن أمكن بشكل عام مثل "بداية السنة" أو "العام الماضي"]"، و**شجع المستخدم بقوة على الرجوع للمصادر الرسمية** (مثل البنوك مباشرة، وزارة الإسكان، منصة سكني، منصة إيجار، الهيئة العامة للعقار) للحصول على أحدث وأدق معلومة **قبل اتخاذ أي قرار مالي أو عقاري**.
*   **تجنب ذكر تواريخ محددة قديمة** لمعلوماتك إلا للضرورة القصوى عند شرح تطور تاريخي مثلاً، وركز على الوضع "الحالي" قدر المستطاع مع التنويه السابق.
`;

/**
 * Converts the conversation history to Gemini format
 * @param messages The conversation history
 * @returns The conversation history in Gemini format
 */
function convertToGeminiFormat(messages: Message[]) {
  const contents = [];

  // Add system prompt as a user message with a special prefix
  contents.push({
    parts: [{ text: SYSTEM_PROMPT }],
    role: "user",
  });

  // Add a model response to acknowledge the system prompt
  contents.push({
    parts: [
      {
        text: "سأكون مساعدك العقاري وسأقدم معلومات دقيقة باللهجة السعودية حول سوق العقارات السعودي. سأستخدم الإيموجي والعبارات التفاعلية لجعل المحادثة أكثر حيوية! 🏡👍",
      },
    ],
    role: "model",
  });

  // Add the rest of the conversation
  for (const message of messages) {
    const role = message.role === "assistant" ? "model" : "user";
    contents.push({
      parts: [{ text: message.content }],
      role,
    });
  }

  return contents;
}

/**
 * Sends a query to the Gemini API and returns the response
 * @param query The user's query
 * @param conversationHistory Previous messages in the conversation
 * @returns The AI assistant's response
 */
export async function queryGeminiModel(
  query: string,
  conversationHistory: Message[] = [],
): Promise<string> {
  try {
    // Prepare the conversation history
    const messages: Message[] = [
      ...conversationHistory,
      { role: "user", content: query },
    ];

    const contents = convertToGeminiFormat(messages);

    const requestBody: GeminiRequest = {
      contents,
      generationConfig: {
        temperature: 0.8,  // زيادة قليلة في التنوع لإضفاء طابع اللهجة المحلية
        topP: 0.9,
        topK: 40,
        maxOutputTokens: 1000,
      },
    };

    // Make the API request
    const response = await fetch(`${GEMINI_API_URL}?key=${GEMINI_API_KEY}`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify(requestBody),
    });

    if (!response.ok) {
      const errorData = await response.json();
      throw new Error(
        `API error: ${errorData.error?.message || response.statusText}`,
      );
    }

    const data: GeminiResponse = await response.json();

    if (data.error) {
      throw new Error(`Model error: ${data.error.message}`);
    }

    if (data.promptFeedback?.blockReason) {
      throw new Error(`Content blocked: ${data.promptFeedback.blockReason}`);
    }

    if (!data.candidates || data.candidates.length === 0) {
      throw new Error("No response generated");
    }

    return (
      data.candidates[0].content.parts[0].text ||
      "عذراً، لم أتمكن من الإجابة على سؤالك. يرجى المحاولة مرة أخرى."
    );
  } catch (error) {
    console.error("Error querying Gemini model:", error);
    return "حدث خطأ أثناء الاتصال بنموذج الذكاء الاصطناعي. يرجى المحاولة مرة أخرى لاحقاً.";
  }
}

/**
 * A mock function that simulates the Gemini API for development and testing
 * @param query The user's query
 * @returns A simulated response based on keywords in the query
 */
export async function mockGeminiQuery(query: string): Promise<string> {
  // Simulate network delay
  await new Promise((resolve) => setTimeout(resolve, 1500));

  // Sample responses based on query keywords
  if (query.includes("شروط التمويل") || query.includes("البنك")) {
    return "هلا وغلا! 👋 تبي تعرف شروط التمويل العقاري عندنا في السعودية؟ 🏦\n\nالبنوك السعودية عندها كم شرط أساسي للتمويل العقاري:\n\n✅ لازم تكون سعودي الجنسية\n✅ عمرك ما يقل عن ٢١ سنة، وما يزيد عن ٦٠ سنة بنهاية فترة التمويل\n✅ راتبك الشهري ما يقل عن ٤٠٠٠ ريال (وترا كل بنك يختلف شوي)\n✅ الأقساط الشهرية ما تتجاوز ٦٥٪؜ من راتبك حسب شريحة دخلك\n\nوالله يوفقك! ترا البنك الأهلي والراجحي عندهم عروض حلوة هالفترة 🔥 تقدر تشيك مواقعهم الرسمية عشان تعرف التفاصيل الدقيقة. أي سؤال ثاني أنا حاضر! 💯";
  } else if (query.includes("الدعم السكني") || query.includes("حساب الدعم")) {
    return "يا هلا! 🌟 تبي تحسب الدعم السكني المناسب لحالتك؟ تمام عليك!\n\nالدعم السكني يعتمد على شيئين أساسيين:\n\n1️⃣ دخلك الشهري\n2️⃣ عدد أفراد أسرتك\n\nإذا دخلك ١٤ ألف ريال أو أقل، راح تاخذ دعم كامل (١٠٠٪؜) لأرباح التمويل 🎯\n\nأما إذا دخلك أعلى، فالنسبة تقل بمعدل ٥٪؜ مع كل ١٠٠٠ ريال زيادة 📉\n\nالحين فيه تطبيق سكني 📱 يبيلك تنزله عشان تسوي حسابك بدقة وتشوف الخيارات المتاحة لك بشكل مفصل. حط بباللك ترا الدعم السكني جزء من رؤية ٢٠٣٠ وفيه تحديثات بين فترة وفترة! 💪";
  } else if (
    query.includes("التمويل الثابت") ||
    query.includes("التمويل المتغير")
  ) {
    return "بسم الله نبدأ! 🌟 الفرق بين التمويل الثابت والمتغير هو الفرق اللي يهمك في القرار!\n\n⚓ التمويل الثابت:\n- معدل الربح (الفايدة) ثابت طول مدة العقد\n- القسط الشهري ما يتغير، يعني تعرف بالضبط وش بتدفع كل شهر\n- مناسب للي يبي يضبط ميزانيته بدون مفاجآت\n\n🎢 التمويل المتغير:\n- معدل الربح يتغير حسب مؤشر السايبور (SAIBOR)\n- قسطك الشهري ممكن يزيد أو ينقص\n- ممكن يكون أوفر على المدى الطويل (بس فيه مخاطرة)\n\nنصيحتي لك؟ 💡 أغلب الأسر السعودية تفضل التمويل الثابت، خاصة للي عندهم دعم سكني من الدولة. بالتوفيق يا غالي! 🏡";
  } else if (
    query.includes("أقصى مبلغ تمويل") ||
    query.includes("مبلغ يمكنني الحصول عليه")
  ) {
    return "هلا بالغالي! 💰 سؤال مهم وأبيك تنتبه له زين!\n\nالمبلغ اللي تقدر تاخذه كتمويل عقاري يعتمد على عدة أمور:\n\n💼 راتبك الشهري (كم تكسب)\n📊 الالتزامات المالية الحالية (كم عليك من قروض وأقساط)\n📝 نسبة الاستقطاع المسموحة حسب دخلك (ما تزيد عن ٦٥٪؜ غالبًا)\n⏱️ مدة التمويل (كم سنة بتسدد)\n\nالبنوك السعودية عادة تمول لين ٩٠٪؜ من قيمة المسكن الأول.\n\nترا كل ١٠٠٠ ريال زيادة في راتبك تقدر تحصل على ١٢٠،٠٠٠ ريال زيادة في التمويل تقريبًا! 🔍\n\nودك تعرف بالضبط؟ استخدم حاسبة التمويل في موقعنا أو شيك على موقع البنك اللي تبيه! 📱\n\nوالله يرزقك البيت اللي يناسبك ويسعدك يارب! 🏡";
  } else if (query.includes("سعر الفائدة") || query.includes("معدل الربح")) {
    return "يا هلا! 👋 معدلات الربح (الفايدة) حاليًا في سوق التمويل العقاري عندنا في السعودية مرة حلوة! 📊\n\n🔍 تتراوح الآن بين ٣٪؜ و٦٪؜ على حسب:\n- البنك اللي تختاره\n- نوع التمويل (ثابت أو متغير)\n- مدة السداد\n- سجلك الائتماني (سمه)\n\n💎 ترا البرامج المدعومة من وزارة الإسكان عادة تكون بمعدلات أقل وأحلى! والله يوفقك.\n\n💯 الحلو في الموضوع إن صندوق التنمية العقارية يغطي جزء كبير من الأرباح حسب دخلك! يعني إذا دخلك أقل من ١٤ ألف، ممكن ما تدفع فايدة أبد (١٠٠٪؜ دعم)! 🎁\n\nعندك أي استفسار ثاني أنا حاضر! 🌟";
  } else if (query.includes("برنامج سكني") || query.includes("وزارة الإسكان")) {
    return "يا هلا فيك! 🏠 برنامج سكني هو نعمة من الله ثم من حكومتنا الرشيدة! 🇸🇦\n\nهذا البرنامج يساعدك تمتلك بيتك بطرق متعددة:\n\n🏙️ وحدات جاهزة (فلل وشقق)\n🏗️ وحدات تحت الإنشاء\n🏞️ أراضي سكنية\n💰 تمويل مدعوم من الدولة\n🧱 البناء الذاتي\n\nعشان تستفيد، لازم تسوي التالي:\n1️⃣ سجل في بوابة سكني الإلكترونية أو حمل التطبيق\n2️⃣ تابع الإعلانات الجديدة (يطلقون مشاريع بشكل دوري)\n3️⃣ احضر للحجز بسرعة لأن المشاريع الحلوة تنحجز بسرعة! ⚡\n\nكل هذا جزء من رؤية المملكة ٢٠٣٠ 💚 وهدفهم يوصلون نسبة تملك المواطنين للمساكن لـ ٧٠٪؜\n\nالله يوفقك ويرزقك البيت اللي تتمناه! 🤲";
  } else if (query.includes("افضل مناطق") || query.includes("استثمار عقاري")) {
    return "يا مرحبا بك! 🌆 وجهت سؤال مهم عن الاستثمار العقاري في السعودية!\n\nالمناطق اللي فيها إقبال حاليًا في سوق العقار:\n\n🏙️ الرياض: شمال الرياض (العارض، حطين، الملقا) مرة مطلوبة\n\n🌊 جدة: شمال جدة وأبحر والشاطئ فيها فرص حلوة\n\n🔥 المناطق القريبة من مشاريع رؤية ٢٠٣٠ الكبرى مثل:\n- القدية\n- نيوم\n- البحر الأحمر\n- ذا لاين\n\n💡 نصائح مهمة للاستثمار:\n1. شف المنطقة بنفسك قبل لا تشتري\n2. تأكد من سلامة الصك والوثائق\n3. استشر مقيّم عقاري معتمد\n4. ادرس المخططات المستقبلية للمنطقة\n\nتذكر! ✨ العقار استثمار طويل المدى، والصبر مفتاح النجاح فيه.\n\nالله يوفقك في استثمارك! 💯";
  } else {
    return "هلا بك يا غالي! 👋\n\nشكرًا على سؤالك. تراني حابب أقدم لك معلومات دقيقة وموثوقة، وعشان كذا أنصحك بالتالي:\n\n🏦 للأمور البنكية: تواصل مع البنك اللي تبيه بشكل مباشر\n\n🏠 للبرامج السكنية: زور موقع وزارة الإسكان أو برنامج سكني الرسمي\n\n💻 للمعلومات المحدثة: تابع:\n- صندوق التنمية العقارية: https://www.sdf.gov.sa\n- بوابة سكني: https://sakani.sa\n\nإذا عندك أي استفسار ثاني عن العقار في السعودية، ترا أنا موجود ومستعد أساعدك بأي معلومات متاحة! 🌟\n\nبالتوفيق يا رب! 🤲";
  }
}
